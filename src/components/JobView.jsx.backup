import { useParams, useNavigate } from 'react-router-dom'
import { useRef, useState } from 'react'
import { format } from 'date-fns'
import html2canvas from 'html2canvas'
import jsPDF from 'jspdf'
import { Card } from './ui/card'
import { Alert, AlertDescription } from './ui/alert'
import { Button } from './ui/button'
import { Badge } from './ui/badge'
import { shouldHideField } from '../utils/userPreferences'
import {
  User,
  Home,
  Calendar,
  Clock,
  Users,
  DollarSign,
  FileText,
  ChevronRight,
  ArrowLeft,
  Download,
  Image as ImageIcon,
  Phone,
  Mail,
  MapPin
} from 'lucide-react'

export default function JobView({ data, viewMode }) {
  const { jobId } = useParams()
  const navigate = useNavigate()
  const [isExporting, setIsExporting] = useState(false)
  const contentRef = useRef(null)

  if (!data) {
    return (
      <div className="space-y-6">
        <h1 className="text-3xl font-bold tracking-tight">Job Details</h1>
        <Alert>
          <AlertDescription>
            No data loaded. Please upload a JSON file on the Admin page.
          </AlertDescription>
        </Alert>
      </div>
    )
  }

  // Find the job
  const job = data.jobs.find(j => j.id === jobId)

  if (!job) {
    return (
      <div className="space-y-6">
        <Button onClick={() => navigate(-1)} variant="outline">
          ← Back
        </Button>
        <Alert>
          <AlertDescription>
            Job not found.
          </AlertDescription>
        </Alert>
      </div>
    )
  }

  // Get assigned teams
  const assignedTeams = data.teams.filter(t => job.scheduledTeams.includes(t.id))

  // Get assigned employees
  const assignedEmployees = data.employees.filter(emp =>
    emp.shifts.some(shift => shift.jobId === job.id)
  )

  // Export as PDF
  const handleExportPDF = async () => {
    if (!contentRef.current) return

    setIsExporting(true)
    try {
      const canvas = await html2canvas(contentRef.current, {
        scale: 2,
        logging: false,
        useCORS: true
      })

      const imgData = canvas.toDataURL('image/png')
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      })

      const imgWidth = 210
      const imgHeight = (canvas.height * imgWidth) / canvas.width

      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight)

      const filename = `Job_${job.customerName.replace(/\s+/g, '_')}_${job.schedule.date}.pdf`
      pdf.save(filename)
    } catch (error) {
      console.error('Error generating PDF:', error)
      alert('Error generating PDF. Please try again.')
    } finally {
      setIsExporting(false)
    }
  }

  // Export as PNG
  const handleExportPNG = async () => {
    if (!contentRef.current) return

    setIsExporting(true)
    try {
      const canvas = await html2canvas(contentRef.current, {
        scale: 2,
        logging: false,
        useCORS: true
      })

      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        link.download = `Job_${job.customerName.replace(/\s+/g, '_')}_${job.schedule.date}.png`
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        URL.revokeObjectURL(url)
        setIsExporting(false)
      })
    } catch (error) {
      console.error('Error generating PNG:', error)
      alert('Error generating PNG. Please try again.')
      setIsExporting(false)
    }
  }

  return (
    <div className="space-y-4 max-w-7xl mx-auto px-4 pb-8">
      {/* Header Controls */}
      <div className="flex items-center justify-between flex-wrap gap-4 pt-4">
        <Button
          onClick={() => navigate(-1)}
          variant="outline"
          className="flex items-center gap-2"
        >
          <ArrowLeft className="w-4 h-4" />
          Back
        </Button>

        <div className="flex items-center gap-2">
          {/* Export Buttons - Style Guide Design */}
          <Button
            onClick={handleExportPDF}
            disabled={isExporting}
            className="flex items-center gap-2 bg-[#BF9F50] hover:bg-[#A88A43] text-white border-2 border-[#1A1A1A] rounded-full px-6 py-2 font-bold shadow-sm"
          >
            <Download className="w-4 h-4" />
            {isExporting ? 'Exporting...' : 'PDF'}
            <ChevronRight className="w-4 h-4" />
          </Button>
          <Button
            onClick={handleExportPNG}
            disabled={isExporting}
            className="flex items-center gap-2 bg-[#0382E5] hover:bg-[#005DA5] text-white border-2 border-[#1A1A1A] rounded-full px-6 py-2 font-bold shadow-sm"
          >
            <ImageIcon className="w-4 h-4" />
            {isExporting ? 'Exporting...' : 'PNG'}
            <ChevronRight className="w-4 h-4" />
          </Button>
        </div>
      </div>

      {/* Job Details - Card Layout */}
      <div ref={contentRef} className="space-y-4">
        {/* Row 1: Customer & Home Info - Full Width */}
        <Card className="p-6">
          <div className="space-y-6">
            {/* Customer Info Section */}
            <div>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-10 h-10 bg-[#005DA5] rounded-lg flex items-center justify-center">
                  <User className="w-5 h-5 text-white" />
                </div>
                <h2 className="text-lg font-bold text-gray-900">Customer Information</h2>
              </div>

              <div className="space-y-3 ml-12">
                <div>
                  <h1 className="text-2xl font-bold text-gray-900">{job.customerName}</h1>
                  <p className="text-lg text-gray-600">{job.serviceType}</p>
                </div>

                {/* Customer Tags */}
                {job.tags && job.tags.filter(tag => tag.type === 'Customer').length > 0 && (
                  <div className="flex flex-wrap gap-2">
                    {job.tags.filter(tag => tag.type === 'Customer').map((tag, idx) => (
                      <Badge
                        key={idx}
                        variant="outline"
                        style={{
                          borderColor: tag.color || '#999999',
                          color: tag.color || '#999999'
                        }}
                      >
                        {tag.description || tag}
                      </Badge>
                    ))}
                  </div>
                )}

                {/* Contact Info */}
                {(
                  (!shouldHideField(viewMode, 'customerPhone', data.metadata?.featureToggles) && job.contactInfo?.phone) ||
                  (!shouldHideField(viewMode, 'customerEmail', data.metadata?.featureToggles) && job.contactInfo?.email)
                ) && (
                  <div className="space-y-2 text-sm">
                    {!shouldHideField(viewMode, 'customerPhone', data.metadata?.featureToggles) && job.contactInfo?.phone && (
                      <div className="flex items-center gap-2 text-gray-700">
                        <Phone className="w-4 h-4 text-[#005DA5]" />
                        <span>{job.contactInfo.phone}</span>
                      </div>
                    )}
                    {!shouldHideField(viewMode, 'customerEmail', data.metadata?.featureToggles) && job.contactInfo?.email && (
                      <div className="flex items-center gap-2 text-gray-700">
                        <Mail className="w-4 h-4 text-[#005DA5]" />
                        <span>{job.contactInfo.email}</span>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            <div className="border-t border-gray-200"></div>

            {/* Home Info Section */}
            <div>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-10 h-10 bg-[#01726B] rounded-lg flex items-center justify-center">
                  <Home className="w-5 h-5 text-white" />
                </div>
                <h2 className="text-lg font-bold text-gray-900">Home Information</h2>
              </div>

              <div className="space-y-3 ml-12">
                {/* Address */}
                <div className="flex items-start gap-2 text-sm text-gray-700">
                  <MapPin className="w-4 h-4 text-[#01726B] mt-0.5 flex-shrink-0" />
                  <span>{job.address}</span>
                </div>

                {/* Home Tags */}
                {job.tags && job.tags.filter(tag => tag.type === 'Home').length > 0 && (
                  <div className="flex flex-wrap gap-2">
                    {job.tags.filter(tag => tag.type === 'Home').map((tag, idx) => (
                      <Badge
                        key={idx}
                        variant="outline"
                        style={{
                          borderColor: tag.color || '#999999',
                          color: tag.color || '#999999'
                        }}
                      >
                        {tag.description || tag}
                      </Badge>
                    ))}
                  </div>
                )}

                {/* Access Information */}
                {!shouldHideField(viewMode, 'accessInformation', data.metadata?.featureToggles) && job.accessInformation && (
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm">
                    <strong className="text-xs text-amber-800 uppercase font-semibold">Access Information</strong>
                    <div
                      className="mt-1 text-gray-700"
                      dangerouslySetInnerHTML={{ __html: job.accessInformation }}
                    />
                  </div>
                )}
              </div>
            </div>
          </div>
        </Card>

        {/* Row 2: Schedule & Pricing - Side by Side on Desktop */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
          {/* Card 2: Schedule */}
          <Card className="p-6">
          <div className="space-y-6">
            <div className="flex items-center gap-2 mb-4">
              <div className="w-10 h-10 bg-[#0382E5] rounded-lg flex items-center justify-center">
                <Calendar className="w-5 h-5 text-white" />
              </div>
              <h2 className="text-lg font-bold text-gray-900">Schedule</h2>
            </div>

            <div className="space-y-4 ml-12">
              {/* Date and Time */}
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-gray-700">
                  <Calendar className="w-4 h-4 text-[#0382E5]" />
                  <span className="font-semibold">
                    {format(new Date(job.schedule.date + 'T12:00:00'), 'EEEE, MMMM d, yyyy')}
                  </span>
                </div>
                <div className="flex items-center gap-2 text-gray-700">
                  <Clock className="w-4 h-4 text-[#0382E5]" />
                  <span>{job.schedule.startTime} - {job.schedule.endTime}</span>
                </div>
              </div>

              {/* Assigned Teams */}
              {assignedTeams.length > 0 && (
                <div>
                  <h3 className="text-sm font-semibold text-gray-600 mb-2">Assigned Teams</h3>
                  <div className="flex flex-wrap gap-2">
                    {assignedTeams.map(team => (
                      <Badge
                        key={team.id}
                        style={{
                          backgroundColor: team.color,
                          color: '#ffffff',
                          border: 'none'
                        }}
                        className="px-3 py-1"
                      >
                        {team.name}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}

              {/* Assigned Employees */}
              {assignedEmployees.length > 0 && (
                <div>
                  <div className="flex items-center gap-2 mb-2">
                    <Users className="w-4 h-4 text-[#01726B]" />
                    <h3 className="text-sm font-semibold text-gray-600">Assigned Employees</h3>
                  </div>
                  <ul className="space-y-2">
                    {assignedEmployees.map(emp => (
                      <li key={emp.id} className="text-sm flex items-center gap-2 ml-6">
                        <span className="font-medium text-gray-900">{emp.name}</span>
                        <span className="text-gray-500">({emp.position.name})</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        </Card>

        {/* Card 3: Pricing */}
        {(
          !shouldHideField(viewMode, 'billRate', data.metadata?.featureToggles) ||
          !shouldHideField(viewMode, 'feeSplitRate', data.metadata?.featureToggles) ||
          job.baseFee ||
          job.serviceSetRateMods?.length > 0 ||
          job.jobRateMods?.length > 0
        ) && (
          <Card className="p-6">
            <div className="space-y-6">
              <div className="flex items-center gap-2 mb-4">
                <div className="w-10 h-10 bg-[#BF9F50] rounded-lg flex items-center justify-center">
                  <DollarSign className="w-5 h-5 text-white" />
                </div>
                <h2 className="text-lg font-bold text-gray-900">Pricing</h2>
              </div>

              <div className="space-y-4 ml-12">
                {/* Bill Rate */}
                {!shouldHideField(viewMode, 'billRate', data.metadata?.featureToggles) && job.billRate && (
                  <div>
                    <p className="text-sm text-gray-600">Bill Rate</p>
                    <p className="text-xl font-bold text-gray-900">${job.billRate.toFixed(2)}</p>
                  </div>
                )}

                {/* Fee Split Rate */}
                {!shouldHideField(viewMode, 'feeSplitRate', data.metadata?.featureToggles) && (() => {
                  let feeSplitTotal = 0
                  if (job.baseFee?.FeeSplit) {
                    feeSplitTotal += job.baseFee.Amount || 0
                  }
                  if (job.serviceSetRateMods) {
                    job.serviceSetRateMods.forEach(mod => {
                      if (mod.FeeSplit) {
                        feeSplitTotal += mod.Amount || 0
                      }
                    })
                  }
                  if (job.jobRateMods) {
                    job.jobRateMods.forEach(mod => {
                      if (mod.FeeSplit) {
                        feeSplitTotal += mod.Amount || 0
                      }
                    })
                  }
                  return feeSplitTotal > 0 ? (
                    <div>
                      <p className="text-sm text-gray-600">Fee Split Rate</p>
                      <p className="text-xl font-bold text-gray-900">${feeSplitTotal.toFixed(2)}</p>
                    </div>
                  ) : null
                })()}

                {/* Rate Breakdown */}
                {(job.baseFee || job.serviceSetRateMods?.length > 0 || job.jobRateMods?.length > 0) && (
                  <div className="border-t border-gray-200 pt-4">
                    <h3 className="text-sm font-semibold text-gray-900 mb-3">Rate Breakdown</h3>

                    {/* Base Fee */}
                    {job.baseFee && (
                      <div className="mb-3">
                        <p className="text-xs font-semibold text-gray-500 uppercase mb-1">Base Fee</p>
                        <div className="text-sm ml-2 text-gray-700">
                          • {job.baseFee.Name}
                          {!shouldHideField(viewMode, 'addOnRate', data.metadata?.featureToggles) && (
                            <span>: ${job.baseFee.Amount.toFixed(2)}</span>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Recurring Modifiers */}
                    {job.serviceSetRateMods && job.serviceSetRateMods.length > 0 && (() => {
                      const hideDiscounts = shouldHideField(viewMode, 'discounts', data.metadata?.featureToggles)
                      const visibleMods = hideDiscounts
                        ? job.serviceSetRateMods.filter(mod => mod.Amount >= 0)
                        : job.serviceSetRateMods

                      return visibleMods.length > 0 ? (
                        <div className="mb-3">
                          <p className="text-xs font-semibold text-gray-500 uppercase mb-1">Recurring Modifiers</p>
                          <div className="text-sm ml-2 space-y-1 text-gray-700">
                            {visibleMods.map((mod, idx) => (
                              <div key={idx}>
                                • {mod.Name}
                                {!shouldHideField(viewMode, 'addOnRate', data.metadata?.featureToggles) && (
                                  <span>: ${mod.Amount.toFixed(2)}</span>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : null
                    })()}

                    {/* One-Time Modifiers */}
                    {(() => {
                      const hideDiscounts = shouldHideField(viewMode, 'discounts', data.metadata?.featureToggles)
                      const visibleMods = job.jobRateMods && job.jobRateMods.length > 0
                        ? (hideDiscounts ? job.jobRateMods.filter(mod => mod.Amount >= 0) : job.jobRateMods)
                        : []

                      return visibleMods.length > 0 ? (
                        <div className="mb-3">
                          <p className="text-xs font-semibold text-gray-500 uppercase mb-1">One-Time Modifiers</p>
                          <div className="text-sm ml-2 space-y-1 text-gray-700">
                            {visibleMods.map((mod, idx) => (
                              <div key={idx}>
                                • {mod.Name}
                                {!shouldHideField(viewMode, 'addOnRate', data.metadata?.featureToggles) && (
                                  <span>: ${mod.Amount.toFixed(2)}</span>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : null
                    })()}
                  </div>
                )}
              </div>
            </div>
          </Card>
        )}

        {/* Card 4: Instructions */}
        {(() => {
          const instructions = []

          if (job.eventInstructions) {
            instructions.push({ label: 'Event', content: job.eventInstructions })
          }
          if (job.specialInstructions) {
            instructions.push({ label: 'Special', content: job.specialInstructions })
          }
          if (job.petInstructions) {
            instructions.push({ label: 'Pets', content: job.petInstructions })
          }
          if (job.directions) {
            instructions.push({ label: 'Directions', content: job.directions })
          }
          if (job.specialEquipment) {
            instructions.push({ label: 'Special Equipment', content: job.specialEquipment })
          }
          if (job.wasteInfo) {
            instructions.push({ label: 'Waste', content: job.wasteInfo })
          }

          return instructions.length > 0 ? (
            <Card className="p-6">
              <div className="space-y-6">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-10 h-10 bg-[#005DA5] rounded-lg flex items-center justify-center">
                    <FileText className="w-5 h-5 text-white" />
                  </div>
                  <h2 className="text-lg font-bold text-gray-900">Instructions</h2>
                </div>

                <div className="space-y-4 ml-12">
                  {instructions.map((inst, idx) => (
                    <div key={idx} className="border-l-4 border-[#0382E5] pl-4 py-2">
                      <strong className="text-xs text-gray-500 uppercase font-semibold block mb-1">
                        {inst.label}
                      </strong>
                      <div
                        className="text-sm text-gray-700"
                        dangerouslySetInnerHTML={{ __html: inst.content }}
                      />
                    </div>
                  ))}
                </div>
              </div>
            </Card>
          ) : null
        })()}

        {/* Card 5: Rooms */}
        {job.rooms && job.rooms.length > 0 && (() => {
          // Group rooms by type
          const roomsByType = job.rooms.reduce((acc, room) => {
            const type = room.type || 'Other'
            if (!acc[type]) {
              acc[type] = []
            }
            acc[type].push(room)
            return acc
          }, {})

          // Find rooms needing DC
          const roomsNeedingDC = {}
          Object.keys(roomsByType).forEach(type => {
            const needsDC = []

            roomsByType[type].forEach(room => {
              const dcCode = room.deepCleanCode ? room.deepCleanCode.toLowerCase() : ''

              if (dcCode === 'always') {
                needsDC.push(room)
              } else if (dcCode !== 'never' && room.lastDeepCleanDate) {
                if (!needsDC.some(r => r.deepCleanCode && r.deepCleanCode.toLowerCase() === 'always')) {
                  if (needsDC.length === 0 || new Date(room.lastDeepCleanDate) < new Date(needsDC[0].lastDeepCleanDate)) {
                    needsDC.splice(0, needsDC.length, room)
                  }
                }
              }
            })

            roomsNeedingDC[type] = needsDC
          })

          const typeOrder = ['Wet', 'Dry', 'Other']
          const sortedTypes = typeOrder.filter(type => roomsByType[type])

          return (
            <Card className="p-6">
              <div className="space-y-6">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-10 h-10 bg-[#01726B] rounded-lg flex items-center justify-center">
                    <Home className="w-5 h-5 text-white" />
                  </div>
                  <h2 className="text-lg font-bold text-gray-900">Rooms ({job.rooms.length})</h2>
                </div>

                <div className="space-y-4 ml-12">
                  {sortedTypes.map(type => {
                    const needsDCRooms = roomsNeedingDC[type] || []

                    return (
                      <div key={type}>
                        <h3 className="text-sm font-semibold text-gray-600 mb-2">{type} Rooms</h3>
                        <div className="space-y-2">
                          {roomsByType[type].map((room, idx) => {
                            const needsDC = needsDCRooms.some(r =>
                              r.name === room.name &&
                              r.lastDeepCleanDate === room.lastDeepCleanDate &&
                              r.deepCleanCode === room.deepCleanCode
                            )

                            return (
                              <div
                                key={idx}
                                className={`border-l-4 pl-4 py-2 rounded ${
                                  needsDC
                                    ? 'border-orange-500 bg-orange-50'
                                    : 'border-gray-300 bg-gray-50'
                                }`}
                              >
                                <div className="flex items-start justify-between">
                                  <div className="flex items-center gap-2">
                                    <strong className="text-sm text-gray-900">{room.name}</strong>
                                    {needsDC && (
                                      <span className="text-xs bg-orange-500 text-white px-2 py-0.5 rounded font-semibold">
                                        NEEDS DC
                                      </span>
                                    )}
                                  </div>
                                  {!shouldHideField(viewMode, 'roomRate', data.metadata?.featureToggles) && room.fee > 0 && (
                                    <span className="text-sm text-gray-600 font-medium">${room.fee.toFixed(2)}</span>
                                  )}
                                </div>
                                {room.detailsOfWork && (
                                  <p className="text-sm text-gray-600 mt-1">{room.detailsOfWork}</p>
                                )}
                                {(room.lastDeepCleanDate || room.deepCleanCode) && (
                                  <div className="text-xs text-gray-500 mt-2 space-y-0.5">
                                    {room.lastDeepCleanDate && (
                                      <p>
                                        <strong>Last DC:</strong> {format(new Date(room.lastDeepCleanDate), 'MMM d, yyyy')}
                                      </p>
                                    )}
                                    {room.deepCleanCode && (
                                      <p>
                                        <strong>DC Code:</strong> {room.deepCleanCode}
                                      </p>
                                    )}
                                  </div>
                                )}
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    )
                  })}
                </div>
              </div>
            </Card>
          )
        })()}

        {/* Job Tags (if any other tags exist) */}
        {job.tags && job.tags.filter(tag => tag.type === 'Job' || !tag.type).length > 0 && (
          <Card className="p-6">
            <div className="space-y-4">
              <h3 className="text-sm font-semibold text-gray-600">Job Tags</h3>
              <div className="flex flex-wrap gap-2">
                {job.tags.filter(tag => tag.type === 'Job' || !tag.type).map((tag, idx) => (
                  <Badge
                    key={idx}
                    variant="outline"
                    style={{
                      borderColor: tag.color || '#999999',
                      color: tag.color || '#999999'
                    }}
                  >
                    {tag.description || tag}
                  </Badge>
                ))}
              </div>
            </div>
          </Card>
        )}

        {/* Footer */}
        <div className="mt-8 pt-4 border-t text-center text-sm text-gray-500">
          Generated from MaidCentral Backup System
        </div>
      </div>
    </div>
  )
}
